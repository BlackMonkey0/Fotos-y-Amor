<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fotos Capturadas</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
    body { font-family: 'Arial', sans-serif; background: #f8f4f0; color: #333; margin: 0; padding: 20px; }
    h1, h2, h3 { text-align: center; }
    .buttons-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
    button, label.upload-btn { 
        padding: 10px 20px; 
        border-radius: 12px; 
        border: none; 
        cursor: pointer; 
        background: #d8b4d8; 
        color: #fff; 
        font-weight: bold; 
        transition: 0.2s; 
        display: inline-block;
        text-align: center;
    }
    button:hover, label.upload-btn:hover { background: #c099c0; }
    input[type="file"] { display: none; }
    .folder { border: 2px solid #d8b4d8; border-radius: 12px; margin: 10px auto; padding: 10px; max-width: 90%; background: #fff0f5; }
    .month { border: 1px dashed #d8b4d8; border-radius: 8px; margin: 8px 0; padding: 8px; }
    .photo-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; }
    .photo-item { position: relative; display: inline-block; }
    .photo-item img { width: 120px; height: auto; border-radius: 8px; cursor: pointer; transition: transform 0.2s, border 0.2s; }
    .photo-item img:hover { transform: scale(1.05); }
    .photo-item img.selected { border: 4px solid #a855f7; box-shadow: 0 0 12px rgba(168,85,247,0.5); }
    .photo-info { text-align: center; font-size: 0.8rem; color: #555; margin-top: 4px; }
</style>
</head>
<body>

<h1>Fotos Capturadas</h1>

<div class="buttons-container">
    <label for="uploadInput" class="upload-btn">游늭 A침adir fotos</label>
    <input type="file" id="uploadInput" accept="image/*" multiple>
    <button id="selectAllButton">Seleccionar todo</button>
    <button id="downloadButton">Descargar seleccionadas</button>
    <button id="clearPhotosBtn">Borrar todas las fotos</button>
    <button id="homeButton">Volver al inicio</button>
</div>

<div id="photoContainer"></div>

<script>
const photoContainer = document.getElementById('photoContainer');
let storedPhotos = JSON.parse(localStorage.getItem('photos')) || [];
const uploadInput = document.getElementById('uploadInput');

// Subir fotos desde archivos locales
uploadInput.addEventListener('change', (event) => {
    const files = event.target.files;
    for (let file of files) {
        const reader = new FileReader();
        reader.onload = (e) => savePhoto(e.target.result);
        reader.readAsDataURL(file);
    }
});

// Guardar foto en localStorage
function savePhoto(photoData) {
    // Intentar guardar coordenadas (si el navegador da permiso)
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const coords = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
            addPhoto(photoData, coords);
        },
        () => {
            addPhoto(photoData, "");
        }
    );
}

function addPhoto(photoData, coords) {
    const newPhoto = {
        photo: photoData,
        location: coords,
        timestamp: Date.now()
    };
    storedPhotos.push(newPhoto);
    localStorage.setItem('photos', JSON.stringify(storedPhotos));
    renderPhotos();
}

// Organizar fotos por a침o y mes
function organizePhotos() {
    const organized = {};
    storedPhotos.forEach(photo => {
        const date = new Date(photo.timestamp || Date.now());
        const year = date.getFullYear();
        const month = date.toLocaleString('es', { month: 'long' });

        if (!organized[year]) organized[year] = {};
        if (!organized[year][month]) organized[year][month] = [];
        organized[year][month].push(photo);
    });
    return organized;
}

// Renderizar fotos
function renderPhotos() {
    photoContainer.innerHTML = '';
    const organized = organizePhotos();

    if (storedPhotos.length === 0) {
        photoContainer.innerHTML = '<p>No hay fotos capturadas.</p>';
        return;
    }

    Object.keys(organized).sort((a,b)=>b-a).forEach(year => {
        const yearFolder = document.createElement('div');
        yearFolder.classList.add('folder');
        const yearTitle = document.createElement('h2');
        yearTitle.textContent = `A침o: ${year}`;
        yearFolder.appendChild(yearTitle);

        Object.keys(organized[year]).forEach(month => {
            const monthFolder = document.createElement('div');
            monthFolder.classList.add('month');
            const monthTitle = document.createElement('h3');
            monthTitle.textContent = month;
            monthFolder.appendChild(monthTitle);

            organized[year][month].forEach((photo) => {
                const photoItem = document.createElement('div');
                photoItem.classList.add('photo-item');

                const img = document.createElement('img');
                img.src = photo.photo;
                img.classList.add('gallery-photo');
                img.addEventListener('click', () => img.classList.toggle('selected'));

                const info = document.createElement('div');
                info.classList.add('photo-info');
                info.textContent = photo.location || '';

                photoItem.appendChild(img);
                photoItem.appendChild(info);
                monthFolder.appendChild(photoItem);
            });

            yearFolder.appendChild(monthFolder);
        });

        photoContainer.appendChild(yearFolder);
    });
}

// Descargar fotos seleccionadas
function downloadSelected() {
    const selected = document.querySelectorAll('.gallery-photo.selected');
    if (selected.length === 0) return alert('Selecciona al menos una foto.');

    const zip = new JSZip();
    selected.forEach((img, i) => {
        const base64 = img.src.split(',')[1];
        zip.file(`foto_${i+1}.png`, base64, { base64: true });
    });

    zip.generateAsync({ type: 'blob' }).then(content => {
        saveAs(content, 'fotos_seleccionadas.zip');
    });
}

// Botones
document.getElementById('selectAllButton').addEventListener('click', () => {
    document.querySelectorAll('.gallery-photo').forEach(img => img.classList.add('selected'));
});

document.getElementById('downloadButton').addEventListener('click', downloadSelected);

document.getElementById('clearPhotosBtn').addEventListener('click', () => {
    if (confirm('쮼st치s seguro de que quieres borrar todas las fotos?')) {
        localStorage.removeItem('photos');
        storedPhotos = [];
        renderPhotos();
        alert('Se han borrado todas las fotos.');
    }
});

document.getElementById('homeButton').addEventListener('click', () => {
    window.location.href = 'index.html';
});

// Inicializar
renderPhotos();
</script>

</body>
</html>
